<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý người dùng - EventHub Admin</title>
    <link rel="stylesheet" th:href="@{/css/admin-coupons.css(v=${#dates.createNow().time})}">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="dark-theme">
<!-- Background Particles -->
<div class="background-particles">
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
</div>
<!-- Header -->
<header class="admin-header glass">
    <div class="header-content">
        <div class="logo-section">
            <div class="logo-icon">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <h1>EventHub Admin</h1>
        </div>
        <div class="admin-info">
            <div class="admin-avatar">
                <i class="fas fa-user-circle"></i>
            </div>
            <span class="admin-name" th:text="${session.userName}">Admin</span>
            <button class="logout-btn glass"
                    th:onclick="|if(confirm('Bạn có chắc chắn muốn đăng xuất?')) { window.location='@{/}'; }|">
                <i class="fas fa-sign-out-alt"></i>
                <span>Đăng xuất</span>
            </button>
        </div>
    </div>
</header>

<!-- Main Content -->
<div class="admin-container">
    <!-- Sidebar Navigation -->
    <nav class="admin-sidebar glass">
        <div class="sidebar-header">
            <div class="admin-avatar-large">
                <i class="fas fa-user-shield"></i>
            </div>
            <span>Quản trị viên</span>
        </div>

        <ul class="nav-menu">
            <li class="nav-item">
                <a th:href="@{/admin-home}" class="nav-link">
                    <div class="nav-icon">
                        <i class="fas fa-tachometer-alt"></i>
                    </div>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a th:href="@{/admin/admin-events}" class="nav-link">
                    <div class="nav-icon">
                        <i class="fas fa-calendar-plus"></i>
                    </div>
                    <span>Quản lý sự kiện</span>
                </a>
            </li>
            <li class="nav-item">
                <a th:href="@{/admin/admin-orders}" class="nav-link">
                    <div class="nav-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <span>Xử lý đơn hàng</span>
                </a>
            </li>
            <li class="nav-item">
                <a th:href="@{/admin/users}" class="nav-link">
                    <div class="nav-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <span>Quản lý người dùng</span>
                </a>
            </li>
            <li class="nav-item">
                <a th:href="@{/admin/admin-create-event}" class="nav-link">
                    <div class="nav-icon">
                        <i class="fas fa-plus-circle"></i>
                    </div>
                    <span>Tạo sự kiện mới</span>
                </a>
            </li>
            <li class="nav-item">
                <a th:href="@{/admin/error-reports}" class="nav-link">
                    <div class="nav-icon"><i class="fas fa-bug"></i></div>
                    <span>Báo lỗi người dùng</span>
                </a>
            </li>
            <li class="nav-item active">
                <a th:href="@{/admin-coupon}" class="nav-link">
                    <div class="nav-icon"><i class="fas fa-tag"></i></div>
                    <span>Khuyến mại</span>
                </a>
            </li>
        </ul>
    </nav>

    <!-- Main Content Area -->
    <main class="main-content">
        <div class="content-header glass">
            <div class="header-left">
                <div class="section-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="header-text">
                    <h2>Quản lý mã giảm giá</h2>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn-primary glass" onclick="openAddCouponModal()">
                    <i class="fas fa-user-plus"></i>
                    <span>Thêm mã giảm giá</span>
                </button>

                <button class="btn-secondary glass" onclick="refreshUsers()">
                    <i class="fas fa-sync-alt"></i>
                    <span>Làm mới</span>
                </button>
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="filters-section glass">
            <div class="filter-group">
                <label for="roleFilter">Sắp xếp:</label>
                <div class="input-wrapper">
                    <div class="input-icon">
                        <i class="fas fa-user-tag"></i>
                    </div>
                    <select id="roleFilter" class="input-border">
                        <option value="admin">A-Z</option>
                        <option value="user">Z-A</option>
                    </select>
                </div>
            </div>
            <div class="filter-group">
                <label for="statusFilter">Trạng thái:</label>
                <div class="input-wrapper">
                    <div class="input-icon">
                        <i class="fas fa-toggle-on"></i>
                    </div>
                    <select id="statusFilter" class="input-border">
                        <option value="">Tất cả trạng thái</option>
                        <option value="active">Còn hạn</option>
                        <option value="inactive">Hết hạn</option>
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn-primary glass" onclick="applyFilters()">
                    <i class="fas fa-filter"></i>
                    <span>Lọc</span>
                </button>
                <button class="btn-secondary glass" onclick="clearFilters()">
                    <i class="fas fa-times"></i>
                    <span>Xóa bộ lọc</span>
                </button>
            </div>
        </div>

        <!-- Users Table -->
        <div class="users-table-container glass">
            <div class="table-header">
                <h3>Danh sách mã</h3>
                <div class="table-actions">
                    <button class="btn-secondary glass" onclick="exportUsers()">
                        <i class="fas fa-download"></i>
                        <span>Xuất Excel</span>
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="users-table">
                    <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        </th>
                        <th>ID</th>
                        <th>Mã giảm giá</th>
                        <th>Giảm giá</th>
                        <th>Loại</th>
                        <th>Ngày hết hạn</th>
                        <th>Đơn giá tối thiểu</th>
                        <th>Thao tác</th>
                    </tr>
                    </thead>
                    <tbody id="usersTableBody">
                    <tr th:each="c : ${coupons}" th:id="'user-row-' + ${c.coupon_id}">
                        <td>
                            <input type="checkbox" class="user-checkbox">
                        </td>

                        <td th:text="${c.coupon_id}">001</td>
                        <td>
                                <span class="role-badge admin" th:text="${c.code}">
                                    SALE50K</span>
                        </td>

                        <td th:text="${c.discount}"
                        >10%
                        </td>

                        <td th:text="${c.type}">fix</td>
                        <td th:text="${#temporals.format(c.expire, 'dd/MM/yyyy hh:mm a')}">27/10/2025</td>
                        <td th:text="${c.condition}">fix</td>

                        <td>
                            <div class="action-buttons">
                                <button class="action-btn edit"
                                        type="button"
                                        th:onclick="'openUpdateCouponModal(' + ${c.coupon_id} + ')'"
                                        title="Chỉnh sửa">
                                    <i class="fas fa-edit"></i>
                                </button>

                                <!--                                <button class="action-btn view"-->
                                <!--                                        type="button"-->
                                <!--                                        th:onclick="'viewUser(' + ${c.coupon_id} + ')'"-->
                                <!--                                        title="Xem chi tiết">-->
                                <!--                                    <i class="fas fa-eye"></i>-->
                                <!--                                </button>-->

                                <button class="action-btn delete"
                                        type="button"
                                        th:onclick="'deleteCoupon(' + ${c.coupon_id} + ')'"
                                        title="Xóa">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination glass">
                <button class="pagination-btn" onclick="previousPage()">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="pagination-btn active">1</button>
                <button class="pagination-btn">2</button>
                <button class="pagination-btn">3</button>
                <span class="pagination-ellipsis">...</span>
                <button class="pagination-btn">10</button>
                <button class="pagination-btn" onclick="nextPage()">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </main>
</div>

<!-- ====================== Add Form===================-->

<form action="#" th:action="@{/admin-coupon/admin-create-coupon}" th:object="${newCoupon}" method="post"
      id="createCouponForm">

    <div id="couponModal" class="modal">
        <div class="modal-content glass">
            <div class="modal-header">
                <h3 id="modalTitle">Thêm mã giảm giá</h3>
                <button type="button" class="close-btn" onclick="closeCouponModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">

                <div class="form-group">
                    <label for="couponCode">Mã Coupon</label>
                    <div class="input-wrapper">
                        <div class="input-icon">
                            <i class="fas fa-ticket-alt"></i>
                        </div>
                        <input type="text" id="couponCode" class="input-border" required
                               th:field="*{code}" placeholder="Vd: SALE50"
                               th:classappend="${#fields.hasErrors('code')} ? 'error-field' : ''">
<!--                        <div class="error"-->
<!--                             th:if="${#fields.hasErrors('code')}"-->
<!--                             th:errors="*{code}">-->
                        </div>
                    <div class="error"
                         th:if="${#fields.hasErrors('code')}"
                         th:errors="*{code}">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="couponType">Loại giảm giá</label>
                        <div class="input-wrapper">
                            <div class="input-icon">
                                <i class="fas fa-percent"></i>
                            </div>
                            <select id="couponType" class="input-border" required
                                    th:field="*{type}"
                                    th:classappend="${#fields.hasErrors('type')} ? 'error-field' : ''">
                                <option value="1">Tiền mặt (fixed)</option>
                                <option value="2">Phần trăm (percent)</option>
                            </select>

                            <!--                            <div class="error"-->
                            <!--                                 th:if="${#fields.hasErrors('type')}"-->
                            <!--                                 th:errors="*{type}">-->
                            <!--                            </div>-->
                        </div>
                        <div class="error"
                             th:if="${#fields.hasErrors('type')}"
                             th:errors="*{type}">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="couponDiscount">Giá trị giảm</label>
                        <div class="input-wrapper">
                            <div class="input-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <input type="number" id="couponDiscount" class="input-border" required
                                   th:field="*{discount}" placeholder="Vd: 50000 hoặc 20"
                                   th:classappend="${#fields.hasErrors('discount')} ? 'error-field' : ''">
                        </div>
                        <div class="error"
                             th:if="${#fields.hasErrors('discount')}"
                             th:errors="*{discount}">
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="couponCondition">Đơn hàng tối thiểu (VND)</label>
                        <div class="input-wrapper">
                            <div class="input-icon">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <input type="number" id="couponCondition" class="input-border"
                                   th:field="*{condition}" placeholder="Giá trị tối thiểu của hàng"
                                   th:classappend="${#fields.hasErrors('condition')} ? 'error-field' : ''">
                        </div>
                        <div class="error"
                             th:if="${#fields.hasErrors('condition')}"
                             th:errors="*{condition}"></div>
                    </div>

                    <div class="form-group">
                        <label for="couponExpire">Ngày hết hạn</label>
                        <div class="input-wrapper">
                            <div class="input-icon">
                                <i class="fas fa-calendar-times"></i>
                            </div>
                            <input type="datetime-local" id="couponExpire" class="input-border" required
                                   th:field="*{expire}"
                                   th:classappend="${#fields.hasErrors('expire') or #fields.hasErrors('global')} ? 'error-field' : ''">

                            <div class="error"
                                 th:if="${#fields.hasErrors('expire')}"
                                 th:errors="*{expire}"></div>
                        </div>
                        <div class="form-group" th:if="${#fields.hasErrors('global')}">
                            <div class="error" th:errors="*{global}">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary glass" onclick="closeCouponModal()">Hủy</button>
                <button class="btn-primary glass" type="submit">Lưu</button>
            </div>
        </div>
    </div>
</form>

<!--==================FORM UPDATE======================-->
<form th:action="@{/admin-coupon/admin-update-coupon/{id}(id=${failedUpdateId != null ? failedUpdateId : 0})}"
      th:object="${couponUpdate}" method="POST"
      id="updateCouponForm">

    <input type="hidden" name="coupon_id" id="updateCouponId">

    <div id="updateCouponModal" class="modal">
        <div class="modal-content glass">
            <div class="modal-header">
                <h3 id="modalUpdateTitle">Cập nhật mã giảm giá</h3>
                <button type="button" class="close-btn" onclick="closeUpdateCouponModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">

                <div class="form-group"><label for="updateCouponCode">Mã Coupon</label>
                    <div class="input-wrapper">
                        <div class="input-icon">
                            <i class="fas fa-ticket-alt"></i>
                        </div>
                        <input type="text" id="updateCouponCode" class="input-border" required
                               th:field="*{code}" placeholder="Vd: SALE50">
                    </div>
                    <div class="error"
                         th:if="${#fields.hasErrors('code')}"
                         th:errors="*{code}">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="updateCouponType">Loại giảm giá</label>
                        <div class="input-wrapper">
                            <div class="input-icon">
                                <i class="fas fa-percent"></i>
                            </div>
                            <select id="updateCouponType" class="input-border" required th:field="*{type}">
                                <option value="1">Tiền mặt (fixed)</option>
                                <option value="2">Phần trăm (percent)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="updateCouponDiscount">Giá trị giảm</label>
                        <div class="input-wrapper">
                            <div class="input-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <input type="number" id="updateCouponDiscount" class="input-border" required
                                   th:field="*{discount}" placeholder="Vd: 50000 hoặc 20">
                        </div>
                        <div class="error"
                             th:if="${#fields.hasErrors('discount')}"
                             th:errors="*{discount}">
                        </div>
                    </div>

                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="updateCouponCondition">Đơn hàng tối thiểu (VND)</label>
                        <div class="input-wrapper">
                            <div class="input-icon">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <input type="number" id="updateCouponCondition" class="input-border"
                                   th:field="*{condition}" placeholder="Bỏ trống nếu không có">
                        </div>
                        <div class="error"
                             th:if="${#fields.hasErrors('condition')}"
                             th:errors="*{condition}">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="updateCouponExpire">Ngày hết hạn</label>
                        <div class="input-wrapper">
                            <div class="input-icon">
                                <i class="fas fa-calendar-times"></i>
                            </div>
                            <input type="datetime-local" id="updateCouponExpire" class="input-border" required
                                   th:field="*{expire}">
                        </div>
                        <div class="error"
                             th:if="${#fields.hasErrors('expire')}"
                             th:errors="*{expire}">
                        </div>
                        <div class="form-group" th:if="${#fields.hasErrors('global')}">
                            <div class="error" th:errors="*{global}">
                            </div></div>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary glass" onclick="closeUpdateCouponModal()">Hủy</button>
                <button class="btn-primary glass" type="submit">Cập nhật</button>
            </div>
        </div>
    </div>
</form>

<!-- Toast Notification -->
<div id="toast" class="toast glass">
    <div class="toast-content">
        <i class="toast-icon"></i>
        <span class="toast-message"></span>
    </div>
</div>

<script th:src="@{/js/admin-coupons.js(v=${#dates.createNow().time})}"></script>
<script th:inline="javascript">
    /*<![CDATA[*/

    document.addEventListener('DOMContentLoaded', function() {

        // --- 1. KIỂM TRA LỖI FORM CREATE ---
        // Kiểm tra BẤT KỲ lỗi nào trên 'newCoupon'
        const hasCreateErrors = /*[[${#fields.hasErrors('newCoupon')}]]*/ false;

        if (hasCreateErrors) {
            const createModal = document.getElementById('couponModal');
            if (createModal) {
                // Sửa thành 'flex' để căn giữa modal
                createModal.style.display = 'flex';
            }
        }

        // --- 2. KIỂM TRA LỖI FORM UPDATE ---
        // Kiểm tra BẤT KỲ lỗi nào trên 'couponUpdate'
        const hasUpdateErrors = /*[[${#fields.hasErrors('couponUpdate')}]]*/ false;

        if (hasUpdateErrors) {
            const updateModal = document.getElementById('updateCouponModal');
            if (updateModal) {
                // Sửa thành 'flex' để căn giữa modal
                updateModal.style.display = 'flex';
            }
        }
    });

    /*]]>*/
</script>
</body>
</html>
